<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <title>ë§Œíˆ¬ í”„ë¡œì íŠ¸ - ë§Œí™”ë¡œ ë§ì§±ëœ¨ì!</title>
  <meta property="og:title" content="ë§Œíˆ¬ í”„ë¡œì íŠ¸">
  <meta property="og:description" content="ë§Œí™”ë¡œ ë§ì§±ëœ¨ì!">
  <meta name="description" content="ë§Œí™”ë¡œ ë§ì§±ëœ¨ì!">
  <meta name="apple-mobile-web-app-title" content="ë§Œíˆ¬ í”„ë¡œì íŠ¸">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #0a0a0a;
      color: #efefef;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      flex-direction: column;
      gap: 1.5rem;
      letter-spacing: -0.025em;
    }
    
    /* ë©”ì¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    #comic-grid { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr); 
      gap: 1.5rem; 
      margin-top: 2rem; 
      width: 100%;
      align-items: start;
    }
    @media (min-width: 640px) { #comic-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1024px) { #comic-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (min-width: 1280px) { #comic-grid { grid-template-columns: repeat(5, 1fr); } }
    
    /* âœ… ì¹´ë“œ ë””ìì¸ ë³µêµ¬: ì˜ˆì „ í¬ê¸° ê·¸ëŒ€ë¡œ ë³´ì¼ ìˆ˜ ìˆê²Œ ë†’ì´ì™€ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .comic-card { 
      position: relative; 
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      background: #222; 
      border-radius: 16px; 
      overflow: visible; 
      width: 100%; 
      display: block; 
      cursor: pointer; 
      border: 2px solid transparent; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .comic-card.disabled { cursor: not-allowed; opacity: 0.8; }
    .comic-card.rank-1 { border-color: #fbbf24; box-shadow: 0 0 30px rgba(251, 191, 36, 0.3); scale: 1.05; z-index: 10; }
    .comic-card.rank-2 { border-color: #94a3b8; }
    .comic-card.rank-3 { border-color: #92400e; }

    /* âœ… ì¹´ë“œ ë‚´ë¶€ ìŠ¤íƒ€ì¼ ë³µêµ¬ (ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„) */
    .comic-card .content { 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      width: 100%; min-height: 140px; padding: 24px; text-align: center; background-color: #1a1a1a; 
      position: relative; border-radius: 14px 14px 0 0;
    }
    .comic-card .nickname-display { font-size: 1.4rem; font-weight: 900; color: #fff; word-break: break-all; }
    .comic-card .sub-text { font-size: 0.9rem; color: #888; margin-top: 8px; font-weight: 500; }
    .comic-card .info-footer { padding: 14px 18px; background: #222; text-align: left; border-radius: 0 0 14px 14px; }
    
    .rank-medal { 
      position: absolute; top: -35px; left: -25px; font-size: 4.5rem; line-height: 1; 
      text-shadow: 0 4px 20px rgba(0,0,0,1); z-index: 100; 
      animation: winner-bounce 2.5s infinite ease-in-out;
    }
    @keyframes winner-bounce {
      0%, 100% { transform: translateY(0) rotate(-5deg) scale(1); }
      50% { transform: translateY(-12px) rotate(5deg) scale(1.1); }
    }

    .like-btn { 
      display: flex; align-items: center; gap: 8px; background: #333; color: white; 
      padding: 10px 18px; border-radius: 24px; font-size: 0.95rem; font-weight: 700; 
      transition: all 0.2s ease; cursor: pointer; border: none; 
    }
    .like-btn.liked { background: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
    .like-count { font-size: 1.2rem; font-weight: 900; color: #fbbf24; margin-left: auto; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.96); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(10px); }
    
    /* ì„¤ì • ëª¨ë‹¬: ìŠ¤í¬ë¡¤ ì—†ì´ ì½¤íŒ©íŠ¸í•˜ê²Œ */
    .modal-content { 
      background-color: #1a1a1a; 
      padding: 1.25rem; 
      border-radius: 24px; 
      border: 1px solid #333;
      max-width: 90vw; 
      width: 360px; 
      display: flex; 
      flex-direction: column;
    }
    
    /* íƒ€ì´ë¨¸ ë””ìì¸ */
    .timer-wrap {
      background: rgba(239, 68, 68, 0.05);
      border: 2px solid rgba(239, 68, 68, 0.4);
      padding: 15px 35px;
      border-radius: 24px;
      margin: 1rem 0 2rem 0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 40px rgba(239, 68, 68, 0.1);
      display: inline-block;
    }
    .timer-wrap.hidden { display: none !important; }
    #timerDisplay { 
      font-family: 'Courier New', Courier, monospace; 
      font-size: 3.2rem; 
      font-weight: 900; 
      color: #ef4444; 
      line-height: 1;
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
    }
    .timer-label { font-size: 0.75rem; font-weight: 900; color: #777; margin-bottom: 6px; letter-spacing: 0.2em; text-transform: uppercase; }
    
    /* âœ… ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì¡°ê·¸ë§£ê²Œ ê³ ì • (80px) */
    #imagePreviewArea { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, 80px); 
      gap: 10px; 
      margin-top: 1rem; 
      justify-content: center;
    }
    .preview-container { position: relative; width: 80px; height: 80px; animation: fadeIn 0.3s ease; }
    .preview-image { width: 80px; height: 80px; object-fit: cover; border-radius: 12px; border: 1px solid #333; }
    
    .custom-file-upload {
      border: 2px dashed #444; border-radius: 20px; padding: 25px 20px; text-align: center; cursor: pointer;
      transition: all 0.3s ease; background: #222; display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .custom-file-upload:hover { border-color: #3b82f6; background: #262626; }
    
    .admin-button { 
      background: #334155; color: white; padding: 12px 20px; border-radius: 12px; 
      cursor: pointer; font-weight: 700; transition: all 0.2s ease; border: 1px solid #475569;
    }
    .admin-button:hover { background: #1e293b; border-color: #64748b; }
    
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-thumb { background-color: #333; border-radius: 10px; border: 2px solid #1a1a1a; }
  </style>
</head>
<body class="text-white">

  <!-- ìƒë‹¨ ì¸ì¦ ë°” -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-3 mb-2 px-4">
    <span id="userInfo" class="text-xs font-bold text-gray-500 uppercase tracking-widest">Connect Wait...</span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-full text-xs font-black hidden">LOGIN</button>
    <button id="signOutBtn" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-1.5 rounded-full text-xs font-black hidden">LOGOUT</button>
  </div>

  <!-- ë©”ì¸ íƒ€ì´í‹€ ì˜ì—­ -->
  <div class="w-full max-w-2xl flex items-center justify-center relative mb-8 px-12 text-center">
    <h1 id="mainTitleDisplay" class="text-5xl font-black text-white tracking-tighter italic">ë§Œíˆ¬ í”„ë¡œì íŠ¸</h1>
    <button id="openSettingsBtn" class="absolute right-0 p-2 text-gray-600 hover:text-white transition-colors hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>
  </div>
  
  <div class="w-full max-w-2xl px-4">
    <img id="mainBanner" class="hidden w-full rounded-3xl shadow-2xl mb-10 object-cover border-4 border-[#1a1a1a]" alt="ë°°ë„ˆ">
  </div>

  <div class="w-full max-w-2xl text-center">
    <h2 id="currentTopicDisplay" class="text-3xl font-black text-yellow-400 mb-2 hidden">
      TOPIC: <span id="currentTopicText" class="px-3 bg-yellow-400 text-black rounded-lg ml-2"></span>
    </h2>

    <div id="timerContainer" class="timer-wrap hidden">
      <p class="timer-label">UPLOAD DEADLINE</p>
      <div id="timerDisplay">00 : 00 : 00</div>
    </div>
  </div>

  <div id="comics-section" class="w-full max-w-6xl">
    <section class="text-center mb-12 flex flex-wrap justify-center gap-5">
      <button id="startContestBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-black py-4 px-10 rounded-2xl text-xl shadow-xl transform transition active:scale-95 hidden">ëŒ€ì „ ì‹œì‘í•˜ê¸°</button>
      <button id="showUploadModalBtn" class="bg-white hover:bg-gray-200 text-black font-black py-4 px-10 rounded-2xl text-xl shadow-xl transform transition active:scale-95 hidden">+ ì‘í’ˆ ì—…ë¡œë“œ</button>
      <button id="endContestBtn" class="admin-button hidden">ì—…ë¡œë“œ ë§ˆê°</button>
      <button id="startVotingBtn" class="admin-button hidden">íˆ¬í‘œ ì‹œì‘</button>
      <button id="endVotingBtn" class="admin-button hidden">ê²°ê³¼ ë°œí‘œ</button>
      <button id="resetContestBtn" class="admin-button hidden text-red-400">ë°ì´í„° ì´ˆê¸°í™”</button>
    </section>
    <div id="comic-grid"></div>
  </div>

  <!-- í†µí•© ëŒ€ì „ ì„¤ì • ëª¨ë‹¬ -->
  <div id="topicModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-black mb-5 tracking-tighter uppercase text-center">CONTEST SETTINGS</h2>
      
      <div class="mb-4 text-left">
        <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase tracking-widest">Contest Topic</label>
        <input type="text" id="topicInput" class="w-full p-2.5 rounded-xl bg-gray-900 border border-gray-800 text-white font-black text-base focus:border-blue-500 outline-none" placeholder="ëŒ€ì „ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div class="mb-4 text-left">
        <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase tracking-widest">Time Limit (Hour : Min)</label>
        <div class="flex gap-2 items-center">
          <div class="flex-1">
            <input type="number" id="timerHourInput" value="0" min="0" class="w-full p-2.5 rounded-xl bg-gray-900 border border-gray-800 text-white font-black text-lg text-center focus:border-red-500 outline-none">
          </div>
          <span class="text-xl font-bold text-gray-700">:</span>
          <div class="flex-1">
            <input type="number" id="timerMinInput" value="30" min="0" max="59" class="w-full p-2.5 rounded-xl bg-gray-900 border border-gray-800 text-white font-black text-lg text-center focus:border-red-500 outline-none">
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between mb-6 bg-gray-900/50 p-2.5 rounded-xl border border-gray-800">
        <span class="text-xs font-bold text-gray-400">ì¢…ë£Œ ì‹œ ìë™ ë§ˆê°</span>
        <input type="checkbox" id="autoEndCheck" class="w-5 h-5 rounded accent-red-600 cursor-pointer" checked>
      </div>

      <div class="flex justify-center gap-2">
        <button id="closeTopicModalBtn" class="flex-1 bg-gray-800 py-3 rounded-xl font-bold text-gray-400 hover:text-white transition-colors">ì·¨ì†Œ</button>
        <button id="submitTopicBtn" class="flex-[1.5] bg-blue-600 py-3 rounded-xl font-black text-white hover:bg-blue-500 transition-colors shadow-lg">ì„¤ì •</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ì„¼í„° -->
  <div id="settingsModal" class="modal">
    <div class="modal-content w-full max-w-md text-center !p-6">
      <h2 class="text-3xl font-black mb-10 tracking-tight">ADMIN CENTER</h2>
      <div class="mb-8 text-left">
        <label class="block text-xs font-black text-gray-500 mb-2 uppercase tracking-widest">App Title</label>
        <div class="flex gap-2"><input type="text" id="newTitleInput" class="flex-1 p-4 rounded-xl bg-gray-900 border border-gray-800 text-white font-bold"><button id="saveTitleBtn" class="bg-blue-600 px-6 py-2 rounded-xl font-black">SAVE</button></div>
      </div>
      <div class="mb-10 text-left">
        <label class="block text-xs font-black text-gray-500 mb-2 uppercase tracking-widest">Banner Image</label>
        <button id="triggerBannerBtn" class="w-full bg-gray-800 py-5 rounded-xl font-black border-2 border-dashed border-gray-700 text-gray-400 hover:text-white hover:border-blue-500 transition-all">UPLOAD JPG</button>
        <input type="file" id="bannerFileInput" accept="image/*" class="hidden">
      </div>
      <div class="flex justify-center"><button id="closeSettingsModalBtn" class="bg-gray-800 px-12 py-3 rounded-2xl font-black text-gray-400 hover:text-white">CLOSE</button></div>
    </div>
  </div>

  <!-- ì‘í’ˆ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
  <div id="imageModal" class="modal">
    <div class="modal-content relative bg-black border-none !p-0 max-w-4xl w-full">
      <button id="closeImageModalBtn" class="fixed top-8 right-8 text-white bg-white bg-opacity-10 hover:bg-opacity-20 rounded-full w-14 h-14 flex items-center justify-center z-50 text-3xl transition-all">âœ•</button>
      <h3 id="modalComicNickname" class="text-2xl font-black p-6 text-white text-center tracking-tighter sticky top-0 bg-black/50 backdrop-blur-md z-10"></h3>
      <div id="modalImageContainer" class="flex flex-col gap-0 w-full pb-20"></div>
    </div>
  </div>

  <!-- âœ… ì‘í’ˆ ì—…ë¡œë“œ ëª¨ë‹¬ (ì‘ê°€ëª… ë° ë¯¸ë¦¬ë³´ê¸° í¬ê¸° ìµœì í™”) -->
  <div id="uploadModal" class="modal">
    <div class="modal-content w-full !max-w-xl !p-6" style="width: auto; min-width: 360px;">
      <h2 class="text-3xl font-black mb-8 text-center tracking-tight">ì‘í’ˆ ì—…ë¡œë“œ</h2>
      <div class="mb-6 text-left">
        <label class="block text-xs font-black text-gray-500 mb-2 uppercase tracking-widest font-bold">ì‘ê°€ëª…</label>
        <input type="text" id="uploadNickname" class="w-full p-4 rounded-2xl bg-gray-900 border border-gray-800 text-white font-black text-xl focus:border-blue-500 outline-none" placeholder="ì‘ê°€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <div class="mb-4 text-left">
        <label class="block text-xs font-black text-gray-500 mb-2 uppercase tracking-widest font-bold">ì‘í’ˆ ì„ íƒ</label>
        <!-- ğŸ’¡ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
        <div id="customFileUpload" class="custom-file-upload">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-8 h-8 text-gray-600">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          <span class="font-bold text-gray-400 text-[11px]">ì´ë¯¸ì§€ íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</span>
        </div>
        <input type="file" id="comicFilesInput" multiple accept="image/*" class="hidden">
      </div>
      <!-- âœ… 80px ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
      <div id="imagePreviewArea"></div>
      <div class="flex justify-end gap-4 mt-8">
        <button id="cancelUploadBtn" class="bg-gray-800 px-8 py-4 rounded-2xl font-black text-gray-400">ì·¨ì†Œ</button>
        <button id="submitComicBtn" class="bg-blue-600 hover:bg-blue-500 px-12 py-4 rounded-2xl font-black shadow-xl">ì—…ë¡œë“œ ì™„ë£Œ</button>
      </div>
    </div>
  </div>

  <div id="generalPasswordModal" class="modal">
    <div class="modal-content w-full max-w-sm text-center">
      <h2 id="passwordModalTitle" class="text-2xl font-black mb-8 tracking-tighter">VERIFICATION</h2>
      <input type="password" id="generalPasswordInput" class="w-full p-4 rounded-2xl bg-gray-900 border border-gray-800 text-white text-center mb-8 font-black text-2xl tracking-widest">
      <div class="flex justify-center gap-3"><button id="closePasswordModalBtn" class="bg-gray-800 px-6 py-2 rounded-xl font-bold">ì·¨ì†Œ</button><button id="confirmPasswordBtn" class="bg-blue-600 px-6 py-2 rounded-xl font-black">í™•ì¸</button></div>
    </div>
  </div>

  <div id="alert-modal" class="modal"><div class="modal-content max-w-xs text-center"><p id="modal-message" class="text-lg font-bold mb-10"></p><button id="modal-confirm-btn" class="w-full py-4 bg-blue-600 rounded-2xl font-black shadow-lg">í™•ì¸</button></div></div>
  <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[2000] flex items-center justify-center hidden"><div class="flex flex-col items-center"><div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent mb-8 shadow-2xl shadow-blue-600/20"></div><p id="loading-text" class="text-xl font-black text-blue-500 tracking-tighter uppercase">Processing...</p></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, deleteDoc, collection, onSnapshot, query, orderBy, serverTimestamp, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const FB_CONFIG = {
      apiKey: "AIzaSyBqtqjmEIPydo7ibbGePf_oEb0GXVcZI6E",
      authDomain: "ne-cut-battle.firebaseapp.com",
      projectId: "ne-cut-battle",
      storageBucket: "ne-cut-battle.firebasestorage.app"
    };

    const APP_ID = "necut_battle_2025";
    const ADMIN_PW = "0614";

    const app = initializeApp(FB_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    let state = { status: "", topic: "", comics: [], files: [], pending: null, timerEnd: 0, autoEndUpload: false, hasAutoEnded: false };
    let timerInterval = null;

    const el = (id) => document.getElementById(id);
    const showLoading = (show, text = "Processing...") => { el('loading-text').textContent = text; el('loading-overlay').classList.toggle('hidden', !show); };

    const showAlert = (msg) => {
      el('modal-message').innerHTML = msg;
      el('alert-modal').style.display = 'flex';
      return new Promise(res => { el('modal-confirm-btn').onclick = () => { el('alert-modal').style.display = 'none'; res(); }; });
    };

    const setAppTitle = (title) => {
      const finalTitle = title || "ë§Œíˆ¬ í”„ë¡œì íŠ¸";
      el('mainTitleDisplay').textContent = finalTitle;
      document.title = `${finalTitle} - ë§Œí™”ë¡œ ë§ì§±ëœ¨ì!`;
    };

    const updateTimerDisplay = () => {
      const isUploadMode = state.status === 'uploading';
      const container = el('timerContainer');

      if (!state.timerEnd || !isUploadMode) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');
      const now = Date.now();
      const diff = state.timerEnd - now;

      if (diff <= 0) {
        el('timerDisplay').textContent = "00 : 00 : 00";
        if (state.autoEndUpload && isUploadMode && !state.hasAutoEnded) {
          state.hasAutoEnded = true; 
          triggerAutoEnd();
        }
        return;
      }

      const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
      const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
      const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
      el('timerDisplay').textContent = `${h} : ${m} : ${s}`;
    };

    const triggerAutoEnd = async () => {
      await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'upload_ended', timerEnd: 0 }, { merge: true });
    };

    const renderComics = () => {
      const grid = el('comic-grid'); grid.innerHTML = '';
      let list = [...state.comics];
      if (state.topic) list = list.filter(c => c.topic === state.topic);
      if (state.status === 'results') list.sort((a, b) => Object.keys(b.likes || {}).length - Object.keys(a.likes || {}).length);
      
      list.forEach((c, i) => {
        const likes = Object.keys(c.likes || {}).length;
        const hasLiked = auth.currentUser && c.likes?.[auth.currentUser.uid];
        const isOwner = auth.currentUser && c.uploaderId === auth.currentUser.uid;
        let rankClass = "", medal = "";
        if (state.status === 'results' && i < 3) {
          rankClass = `rank-${i + 1}`; 
          medal = `<div class="rank-medal">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i]}</div>`;
        }
        const card = document.createElement('div');
        card.className = `comic-card ${rankClass} ${state.status === 'uploading' ? 'disabled' : ''}`;
        card.innerHTML = `
          ${medal}
          <div class="content"><span class="nickname-display">${c.uploaderName}</span><span class="sub-text">${c.images?.length}ì»· ì‘í’ˆ</span></div>
          <div class="info-footer flex items-center">
            <button class="like-btn ${hasLiked ? 'liked' : ''} ${state.status !== 'voting' ? 'disabled' : ''}">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="${hasLiked ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
              </svg>
              <span>${hasLiked ? 'ì™„ë£Œ' : 'ì¢‹ì•„ìš”'}</span>
            </button>
            <span class="like-count">${likes}</span>
          </div>
          ${isOwner && state.status !== 'results' ? `<button class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full w-9 h-9 flex items-center justify-center z-50 shadow-xl del-btn font-black text-xs">âœ•</button>` : ''}
        `;
        card.onclick = (e) => {
          if (e.target.closest('button')) return;
          if (state.status === 'uploading') return showAlert('ë§ˆê° í›„ì— ì‘í’ˆì´ ê³µê°œë©ë‹ˆë‹¤.');
          if (state.status === 'upload_ended') { state.pending = () => openViewer(c); showPasswordModal("ê´€ë¦¬ììš© ì—´ëŒ"); return; }
          openViewer(c);
        };
        card.querySelector('.like-btn').onclick = (e) => { 
          e.stopPropagation(); 
          if (state.status === 'voting') toggleLike(c.id); 
          else showAlert(state.status === 'results' ? 'íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'íˆ¬í‘œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.'); 
        };
        const delBtn = card.querySelector('.del-btn');
        if (delBtn) delBtn.onclick = (e) => { e.stopPropagation(); handleDelete(c.id); };
        grid.appendChild(card);
      });
    };

    const openViewer = (c) => {
      el('modalComicNickname').textContent = `${c.uploaderName} ì‘ê°€ë‹˜`;
      const con = el('modalImageContainer'); con.innerHTML = '';
      c.images.forEach(img => { 
        const i = document.createElement('img'); i.src = img.imageUrl; i.className = "w-full block"; con.appendChild(i); 
      });
      el('imageModal').style.display = 'flex';
    };

    const setupSync = () => {
      onSnapshot(doc(db, `artifacts/${APP_ID}/public/data/config/current`), (d) => {
        const data = d.data(); if (!data) return;
        state.status = data.status || ""; state.topic = data.topic || "";
        state.timerEnd = data.timerEnd || 0;
        state.autoEndUpload = data.autoEndUpload || false;
        state.hasAutoEnded = false; 
        setAppTitle(data.appTitle);
        if (data.bannerUrl && state.status === "") { el('mainBanner').src = data.bannerUrl; el('mainBanner').classList.remove('hidden'); }
        else { el('mainBanner').classList.add('hidden'); }
        el('currentTopicText').textContent = state.topic;
        el('currentTopicDisplay').classList.toggle('hidden', !state.topic);
        refreshUI(); renderComics(); updateTimerDisplay(); 
      });
      onSnapshot(query(collection(db, `artifacts/${APP_ID}/public/data/comics`), orderBy("timestamp", "desc")), (s) => {
        state.comics = s.docs.map(d => ({ id: d.id, ...d.data() }));
        renderComics();
      });
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    };

    const refreshUI = () => {
      const user = auth.currentUser;
      const isMgr = user && !user.isAnonymous;
      el('userInfo').textContent = user ? (user.displayName || "GUEST MODE") : "OFFLINE";
      el('startContestBtn').classList.toggle('hidden', !isMgr || state.status !== "");
      el('showUploadModalBtn').classList.toggle('hidden', state.status !== "uploading");
      el('endContestBtn').classList.toggle('hidden', !isMgr || state.status !== "uploading");
      el('startVotingBtn').classList.toggle('hidden', !isMgr || state.status !== "upload_ended");
      el('endVotingBtn').classList.toggle('hidden', !isMgr || state.status !== "voting");
      el('resetContestBtn').classList.toggle('hidden', !isMgr || state.status !== "results");
      el('openSettingsBtn').classList.toggle('hidden', !isMgr);
      el('signInBtn').classList.toggle('hidden', !!user && !user.isAnonymous);
      el('signOutBtn').classList.toggle('hidden', !user);
    };

    const toggleLike = async (id) => {
      if (!auth.currentUser || auth.currentUser.isAnonymous) return showAlert("íˆ¬í‘œí•˜ë ¤ë©´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const c = state.comics.find(x => x.id === id); const uid = auth.currentUser.uid;
      if (!c.likes?.[uid] && state.comics.some(x => x.id !== id && x.likes?.[uid])) return showAlert("íˆ¬í‘œëŠ” í•œ ì‘í’ˆì—ë§Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
      await updateDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, id), { [`likes.${uid}`]: c.likes?.[uid] ? deleteField() : true });
    };

    const handleDelete = async (id) => {
      if (confirm("ì •ë§ë¡œ ì´ ì‘í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        showLoading(true, "Deleting...");
        const c = state.comics.find(x => x.id === id);
        for (const img of c.images) if (img.path) await deleteObject(storageRef(storage, img.path)).catch(() => {});
        await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, id));
        showLoading(false);
      }
    };

    const showPasswordModal = (title) => {
      el('passwordModalTitle').textContent = title; el('generalPasswordInput').value = ''; el('generalPasswordModal').style.display = 'flex'; el('generalPasswordInput').focus();
    };

    el('confirmPasswordBtn').onclick = () => {
      if (el('generalPasswordInput').value === ADMIN_PW) { el('generalPasswordModal').style.display = 'none'; if (state.pending) { state.pending(); state.pending = null; } }
      else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    };

    const resizeImg = (file, maxWidth = 1280, quality = 0.8) => {
      return new Promise((res) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image(); img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
            canvas.toBlob((b) => res(b.size < file.size ? b : file), 'image/jpeg', quality);
          };
        };
      });
    };

    // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìœ ì§€
    const uploadInput = el('comicFilesInput');
    const customUploadBtn = el('customFileUpload');
    customUploadBtn.onclick = () => uploadInput.click();
    
    customUploadBtn.addEventListener('dragover', (e) => { e.preventDefault(); customUploadBtn.style.borderColor = '#3b82f6'; customUploadBtn.style.background = '#262626'; });
    customUploadBtn.addEventListener('dragleave', () => { customUploadBtn.style.borderColor = '#444'; customUploadBtn.style.background = '#222'; });
    customUploadBtn.addEventListener('drop', (e) => {
      e.preventDefault();
      customUploadBtn.style.borderColor = '#444'; customUploadBtn.style.background = '#222';
      const droppedFiles = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      if (droppedFiles.length > 0) { state.files = [...state.files, ...droppedFiles]; renderPreviews(); }
    });

    uploadInput.onchange = (e) => { state.files = [...state.files, ...Array.from(e.target.files)]; renderPreviews(); };

    const renderPreviews = () => {
      const area = el('imagePreviewArea'); area.innerHTML = '';
      if (state.files.length === 0) return;
      state.files.forEach((f, i) => {
        const div = document.createElement('div'); div.className = 'preview-container';
        div.innerHTML = `<img src="${URL.createObjectURL(f)}" class="preview-image"><button class="absolute -top-1.5 -right-1.5 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-black shadow-lg text-[8px] z-10">âœ•</button>`;
        div.querySelector('button').onclick = () => { state.files.splice(i, 1); renderPreviews(); };
        area.appendChild(div);
      });
    };

    el('submitComicBtn').onclick = async () => {
      if (!auth.currentUser || auth.currentUser.isAnonymous) return showAlert("ì—…ë¡œë“œí•˜ë ¤ë©´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const name = el('uploadNickname').value.trim(); 
      if (!name || state.files.length === 0) return showAlert("ì‘ê°€ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      showLoading(true, "Processing...");
      try {
        const ref = doc(collection(db, `artifacts/${APP_ID}/public/data/comics`)); const imgs = [];
        for (let i = 0; i < state.files.length; i++) {
          const blob = await resizeImg(state.files[i]);
          const path = `mantu/${APP_ID}/${ref.id}/${i}_${Date.now()}.jpg`;
          const sRef = storageRef(storage, path); await uploadBytesResumable(sRef, blob);
          const url = await getDownloadURL(sRef); imgs.push({ imageUrl: url, path });
        }
        await setDoc(ref, { uploaderId: auth.currentUser.uid, uploaderName: name, images: imgs, likes: {}, timestamp: serverTimestamp(), topic: state.topic });
        el('uploadModal').style.display = 'none'; state.files = []; showAlert("ì‘í’ˆì´ ì„±ê³µì ìœ¼ë¡œ<br>ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } catch (e) { showAlert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); } showLoading(false);
    };

    el('openSettingsBtn').onclick = () => { state.pending = () => { el('newTitleInput').value = el('mainTitleDisplay').textContent; el('settingsModal').style.display = 'flex'; }; showPasswordModal("ADMIN LOGIN"); };
    el('closeSettingsModalBtn').onclick = () => el('settingsModal').style.display = 'none';
    el('saveTitleBtn').onclick = async () => {
      showLoading(true, "Updating...");
      await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { appTitle: el('newTitleInput').value }, { merge: true });
      showAlert("ì œëª©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); showLoading(false);
    };
    el('triggerBannerBtn').onclick = () => el('bannerFileInput').click();
    el('bannerFileInput').onchange = async (e) => {
      if (!e.target.files[0]) return; showLoading(true);
      try {
        const b = await resizeImg(e.target.files[0], 1920, 0.9);
        const sRef = storageRef(storage, `mantu/banners/${APP_ID}/main_${Date.now()}.jpg`);
        await uploadBytesResumable(sRef, b); const url = await getDownloadURL(sRef);
        await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { bannerUrl: url }, { merge: true }); showAlert("ë°°ë„ˆ ë³€ê²½ ì™„ë£Œ");
      } catch (e) { showAlert("ë°°ë„ˆ ì—…ë¡œë“œ ì‹¤íŒ¨"); } showLoading(false);
    };

    el('startContestBtn').onclick = () => { 
      state.pending = () => { el('topicInput').value = ""; el('timerHourInput').value = 0; el('timerMinInput').value = 30; el('topicModal').style.display = 'flex'; };
      showPasswordModal("CONTEST SETTINGS"); 
    };

    el('closeTopicModalBtn').onclick = () => el('topicModal').style.display = 'none';

    el('submitTopicBtn').onclick = async () => {
      const topic = el('topicInput').value.trim();
      const hour = parseInt(el('timerHourInput').value) || 0;
      const min = parseInt(el('timerMinInput').value) || 0;
      const totalMs = (hour * 3600 + min * 60) * 1000;
      if(!topic) return alert("ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if(totalMs <= 0) return alert("ë§ˆê° ì‹œê°„ì„ ì„¤ì •í•˜ì„¸ìš”.");
      showLoading(true);
      const timerEnd = Date.now() + totalMs;
      const autoEnd = el('autoEndCheck').checked;
      await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { 
        status: 'uploading', topic: topic, timerEnd: timerEnd, autoEndUpload: autoEnd, updatedAt: serverTimestamp() 
      }, { merge: true });
      el('topicModal').style.display = 'none'; showLoading(false);
    };

    el('endContestBtn').onclick = () => { state.pending = () => setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'upload_ended', timerEnd: 0 }, { merge: true }); showPasswordModal("ì—…ë¡œë“œ ë§ˆê°"); };
    el('startVotingBtn').onclick = () => { state.pending = () => setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'voting' }, { merge: true }); showPasswordModal("íˆ¬í‘œ ì‹œì‘"); };
    el('endVotingBtn').onclick = () => { state.pending = async () => { await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'results' }, { merge: true }); }; showPasswordModal("ê²°ê³¼ ë°œí‘œ"); };
    el('resetContestBtn').onclick = () => {
      state.pending = async () => {
        if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          showLoading(true, "Cleaning...");
          for (const c of state.comics) { for (const img of c.images) await deleteObject(storageRef(storage, img.path)).catch(()=>{}); await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, c.id)); }
          await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: '', topic: '', timerEnd: 0 }, { merge: true }); showLoading(false);
        }
      }; showPasswordModal("ë°ì´í„° ì´ˆê¸°í™”");
    };

    el('timerContainer').onclick = () => {
      state.pending = () => { el('topicInput').value = state.topic; el('topicModal').style.display = 'flex'; };
      showPasswordModal("CONTEST SETTINGS EDIT");
    };

    const initApp = async () => {
      try { await signInAnonymously(auth); } catch (e) {}
      setupSync();
    };

    initApp();
    onAuthStateChanged(auth, refreshUI);
    el('signInBtn').onclick = () => signInWithPopup(auth, provider);
    el('signOutBtn').onclick = () => signOut(auth);
    el('showUploadModalBtn').onclick = () => { state.files = []; el('imagePreviewArea').innerHTML = ''; el('uploadModal').style.display = 'flex'; };
    el('cancelUploadBtn').onclick = () => el('uploadModal').style.display = 'none';
    el('closeImageModalBtn').onclick = () => el('imageModal').style.display = 'none';
    el('closePasswordModalBtn').onclick = () => el('generalPasswordModal').style.display = 'none';
  </script>
</body>
</html>
