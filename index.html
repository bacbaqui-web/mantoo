<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§Œíˆ¬ - ë„¤ì»·ë§Œí™” íˆ¬í‘œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <!-- íŒŒì¼ ì••ì¶• ë° ì €ì¥ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      flex-direction: column;
      gap: 1rem;
    }
    .section-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
      text-align: center;
      width: 100%;
      max-width: 1200px;
    }
    #comic-grid { column-count: 2; column-gap: 1.5rem; margin-top: 2rem; display: block; }
    @media (min-width: 640px) { #comic-grid { column-count: 3; } }
    @media (min-width: 1024px) { #comic-grid { column-count: 4; } }
    @media (min-width: 1280px) { #comic-grid { column-count: 5; } }
    
    .comic-card { 
      position: relative; 
      transition: all .2s ease-in-out; 
      background: #333; 
      border-radius: 12px; 
      overflow: visible; 
      margin-bottom: 3.5rem; 
      break-inside: avoid; 
      width: 100%; 
      display: block; 
      cursor: pointer; 
      border: 4px solid transparent; 
    }
    .comic-card.disabled { cursor: not-allowed; opacity: 0.7; }
    
    /* ìˆœìœ„ ë©”ë‹¬ ê°•ì¡° ìŠ¤íƒ€ì¼ */
    .comic-card.rank-1 { border-color: #FFD700; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); z-index: 10; scale: 1.05; }
    .comic-card.rank-2 { border-color: #C0C0C0; box-shadow: 0 0 20px rgba(192, 192, 192, 0.3); }
    .comic-card.rank-3 { border-color: #CD7F32; box-shadow: 0 0 20px rgba(205, 127, 50, 0.3); }
    
    .rank-medal { 
      position: absolute; top: -30px; left: -25px; font-size: 4.5rem; line-height: 1; 
      text-shadow: 0 4px 15px rgba(0,0,0,1); z-index: 100; 
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
      animation: winner-bounce 2s infinite ease-in-out;
    }
    @keyframes winner-bounce {
      0%, 100% { transform: translateY(0) scale(1) rotate(-5deg); }
      50% { transform: translateY(-10px) scale(1.1) rotate(5deg); }
    }

    .comic-card:not(.disabled):hover { transform: translateY(-10px); background: #444; }
    
    .comic-card .content { 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      width: 100%; min-height: 130px; padding: 20px; text-align: center; background-color: #1a1a1a; 
      position: relative; border-radius: 9px 9px 0 0;
    }
    .comic-card .nickname-display { font-size: 1.4rem; font-weight: 800; color: #fff; word-break: break-all; }
    .comic-card .sub-text { font-size: 0.85rem; color: #aaa; margin-top: 6px; }
    .comic-card .info-footer { padding: 12px; background: #333; text-align: left; border-radius: 0 0 9px 9px; }
    
    .like-btn { 
      display: flex; align-items: center; gap: 8px; background: #444; color: white; 
      padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; 
      transition: all 0.2s ease; cursor: pointer; border: none; 
    }
    .like-btn.liked { background: #2563eb; box-shadow: 0 0 10px rgba(37, 99, 235, 0.5); }
    .like-btn:not(.disabled):hover:not(.liked) { background: #555; }
    .like-btn.disabled { background: #333; color: #666; cursor: not-allowed; }
    .like-count { font-size: 1.2rem; font-weight: 900; color: #fbbf24; margin-left: 8px; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.95); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { 
      background-color: #1a1a1a; padding: 1.5rem; border-radius: 12px; 
      max-width: 95vw; max-height: 90vh; width: auto; display: flex; flex-direction: column; overflow-y: auto; 
    }
    
    #imagePreviewArea { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 16px; margin-top: 1rem; padding: 16px; background: #1a1a1a; border-radius: 8px; }
    .preview-container { position: relative; width: 100%; aspect-ratio: 1 / 1; }
    .preview-image { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #444; }
    
    .admin-button { background: #475569; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; }
    .admin-button:hover { background: #334155; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; }
  </style>
</head>
<body class="text-white">

  <!-- ìƒë‹¨ ë°” -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-3 mb-2">
    <span id="userInfo" class="text-sm font-bold text-gray-400">ë°ì´í„° í™•ì¸ ì¤‘...</span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg font-bold hidden">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-1.5 rounded-lg font-bold hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë©”ì¸ íƒ€ì´í‹€ ì˜ì—­ -->
  <div class="w-full max-w-2xl flex items-center justify-center relative mb-6 px-12">
    <h1 id="mainTitleDisplay" class="text-4xl font-black text-center text-white tracking-tighter">ë§Œíˆ¬</h1>
    <button id="openSettingsBtn" class="absolute right-0 p-2 text-gray-500 hover:text-white transition-colors hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>
  </div>
  
  <div class="w-full max-w-2xl px-4">
    <img id="mainBanner" class="hidden w-full rounded-xl shadow-2xl mb-8 object-cover border-2 border-gray-800" alt="ë°°ë„ˆ">
  </div>

  <h2 id="currentTopicDisplay" class="text-3xl font-black text-yellow-300 text-center mb-8 hidden">
    ì´ë²ˆ ì£¼ì œ: <span id="currentTopicText" class="px-2 bg-yellow-900 bg-opacity-30 rounded"></span>
  </h2>

  <div id="comics-section" class="section-card text-left">
    <section class="text-center mb-8 flex flex-wrap justify-center gap-4">
      <button id="startContestBtn" class="admin-button hidden">ëŒ€ì „ ì‹œì‘</button>
      <button id="showUploadModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl text-xl shadow-lg hidden">+ ì‘í’ˆ ì˜¬ë¦¬ê¸°</button>
      <button id="endContestBtn" class="admin-button hidden">ì—…ë¡œë“œ ë§ˆê°</button>
      <button id="startVotingBtn" class="admin-button hidden">íˆ¬í‘œ ì‹œì‘</button>
      <button id="endVotingBtn" class="admin-button hidden">íˆ¬í‘œ ì¢…ë£Œ ë° ê²°ê³¼ ë°œí‘œ</button>
      <button id="resetContestBtn" class="admin-button hidden">ì „ì²´ ì´ˆê¸°í™”</button>
    </section>
    <div id="comic-grid"></div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsModal" class="modal">
    <div class="modal-content w-full max-w-md text-center">
      <h2 class="text-2xl font-black mb-8">ê´€ë¦¬ì ì„¼í„°</h2>
      <div class="mb-6 text-left">
        <label class="block text-sm font-bold text-gray-400 mb-1">ì•± ì œëª©</label>
        <div class="flex gap-2"><input type="text" id="newTitleInput" class="flex-1 p-3 rounded-lg bg-gray-800 border border-gray-700 text-white font-bold"><button id="saveTitleBtn" class="bg-blue-600 px-4 py-2 rounded-lg font-bold">ë³€ê²½</button></div>
      </div>
      <div class="mb-8 text-left">
        <label class="block text-sm font-bold text-gray-400 mb-1">JPG ë°°ë„ˆ ì—…ë¡œë“œ</label>
        <button id="triggerBannerBtn" class="w-full bg-gray-700 py-4 rounded-lg font-bold border-2 border-dashed border-gray-600">íŒŒì¼ ì„ íƒ</button><input type="file" id="bannerFileInput" accept="image/*">
      </div>
      <div class="mb-8 pt-6 border-t border-gray-800">
        <button id="downloadAllComicsBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-lg font-black flex items-center justify-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
          ëª¨ë“  ì‘í’ˆ ë‹¤ìš´ë¡œë“œ (.zip)
        </button>
      </div>
      <div class="flex justify-center mt-4"><button id="closeSettingsModalBtn" class="bg-gray-600 px-10 py-2 rounded-lg font-bold">ë‹«ê¸°</button></div>
    </div>
  </div>

  <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-4 right-4 text-white bg-black bg-opacity-60 rounded-full w-10 h-10 flex items-center justify-center z-50 text-2xl">âœ•</button>
      <h3 id="modalComicNickname" class="text-3xl font-black mb-6 text-white text-center"></h3>
      <div id="modalImageContainer" class="flex flex-col gap-6 max-w-xl mx-auto pb-10"></div>
    </div>
  </div>

  <!-- ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="uploadModal" class="modal">
    <div class="modal-content w-full max-w-lg">
      <h2 class="text-2xl font-black mb-8 text-center">ì‘í’ˆ ì œì¶œí•˜ê¸°</h2>
      <div class="mb-6"><label class="block text-sm font-bold text-gray-400 mb-2">ì‘ê°€ ì´ë¦„</label><input type="text" id="uploadNickname" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold" placeholder="ë‹‰ë„¤ì„ì„ ì ì–´ì£¼ì„¸ìš”"></div>
      <div class="mb-6"><label class="file-input-label py-4">ì´ë¯¸ì§€ ì„ íƒ (ì—¬ëŸ¬ ì¥)</label><input type="file" id="comicFilesInput" multiple accept="image/*"></div>
      <div id="imagePreviewArea"></div>
      <div class="flex justify-end gap-3 mt-10"><button id="cancelUploadBtn" class="bg-gray-700 px-8 py-3 rounded-xl font-bold">ì·¨ì†Œ</button><button id="submitComicBtn" class="bg-blue-600 px-10 py-3 rounded-xl font-black">ì œì¶œ ì™„ë£Œ</button></div>
    </div>
  </div>

  <!-- ì¸ì¦ ëª¨ë‹¬ (ë³´ì•ˆ ê°•í™”) -->
  <div id="generalPasswordModal" class="modal">
    <div class="modal-content w-full max-w-sm text-center">
      <h2 id="passwordModalTitle" class="text-2xl font-black mb-6">ê´€ë¦¬ì ì¸ì¦</h2>
      <input type="password" id="generalPasswordInput" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white text-center mb-6 font-bold" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <div class="flex justify-center gap-3"><button id="closePasswordModalBtn" class="bg-gray-700 px-6 py-2 rounded-lg font-bold">ì·¨ì†Œ</button><button id="confirmPasswordBtn" class="bg-blue-700 px-6 py-2 rounded-lg font-black">í™•ì¸</button></div>
    </div>
  </div>

  <div id="topicModal" class="modal">
    <div class="modal-content w-full max-w-sm text-center">
      <h2 class="text-2xl font-black mb-6">ì œì‹œì–´ ì…ë ¥</h2>
      <input type="text" id="topicInput" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white text-center mb-6 font-bold" placeholder="ì˜ˆ: ì²«ì‚¬ë‘, ì ì‹¬ì‹œê°„">
      <div class="flex justify-center gap-3"><button id="closeTopicModalBtn" class="bg-gray-600 px-4 py-2 rounded-lg font-bold">ì·¨ì†Œ</button><button id="submitTopicBtn" class="bg-blue-700 px-6 py-2 rounded-lg font-black">ë§Œíˆ¬ ì‹œì‘!</button></div>
    </div>
  </div>

  <!-- ì•Œë¦¼/ë¡œë”© -->
  <div id="alert-modal" class="modal"><div class="modal-content max-w-xs text-center"><p id="modal-message" class="text-xl font-bold mb-8"></p><button id="modal-confirm-btn" class="w-full py-3 bg-blue-700 rounded-xl font-black">í™•ì¸</button></div></div>
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-90 z-[2000] flex items-center justify-center hidden"><div class="flex flex-col items-center"><div class="animate-spin rounded-full h-14 w-14 border-4 border-blue-500 border-t-transparent mb-6"></div><p id="loading-text" class="text-xl font-black text-blue-400">ì²˜ë¦¬ ì¤‘...</p></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, deleteDoc, collection, onSnapshot, query, orderBy, serverTimestamp, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject, getBlob } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const FB_CONFIG = {
      apiKey: "AIzaSyBqtqjmEIPydo7ibbGePf_oEb0GXVcZI6E",
      authDomain: "ne-cut-battle.firebaseapp.com",
      projectId: "ne-cut-battle",
      storageBucket: "ne-cut-battle.firebasestorage.app"
    };

    const APP_ID = "necut_battle_2025";
    const ADMIN_PW = "0614";

    const app = initializeApp(FB_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    let state = { status: "", topic: "", comics: [], files: [], pending: null };

    const el = (id) => document.getElementById(id);
    const showLoading = (show, text = "ì²˜ë¦¬ ì¤‘...") => { el('loading-text').textContent = text; el('loading-overlay').classList.toggle('hidden', !show); };

    const showAlert = (msg) => {
      el('modal-message').textContent = msg;
      el('alert-modal').style.display = 'flex';
      return new Promise(res => { el('modal-confirm-btn').onclick = () => { el('alert-modal').style.display = 'none'; res(); }; });
    };

    const renderComics = () => {
      const grid = el('comic-grid'); grid.innerHTML = '';
      let list = [...state.comics];
      if (state.topic) list = list.filter(c => c.topic === state.topic);
      
      // ê²°ê³¼ ë°œí‘œ ì •ë ¬ ë° ë©”ë‹¬
      if (state.status === 'results') {
        list.sort((a, b) => Object.keys(b.likes || {}).length - Object.keys(a.likes || {}).length);
      }

      if (list.length === 0) { grid.innerHTML = `<p class="col-span-full py-32 opacity-40 text-center w-full font-bold text-lg">${state.status ? 'ë“±ë¡ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.' : 'ëŒ€ì „ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'}</p>`; return; }

      list.forEach((c, i) => {
        const likes = Object.keys(c.likes || {}).length;
        const hasLiked = auth.currentUser && c.likes?.[auth.currentUser.uid];
        const isOwner = auth.currentUser && c.uploaderId === auth.currentUser.uid;
        
        let rankClass = "", medal = "";
        if (state.status === 'results' && i < 3) {
          rankClass = `rank-${i + 1}`; 
          medal = `<div class="rank-medal">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i]}</div>`;
        }

        const card = document.createElement('div');
        card.className = `comic-card ${rankClass} ${state.status === 'uploading' ? 'disabled' : ''}`;
        card.innerHTML = `${medal}<div class="content"><span class="nickname-display">${c.uploaderName}</span><span class="sub-text">${c.images?.length}ì»·</span></div><div class="info-footer"><div class="like-section"><button class="like-btn ${hasLiked ? 'liked' : ''} ${state.status !== 'voting' ? 'disabled' : ''}"><span>ë”°ë´‰</span></button><span class="like-count">${likes}</span></div></div>${isOwner && state.status !== 'results' ? `<button class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full w-9 h-9 flex items-center justify-center z-50 shadow-xl del-btn font-bold">âœ•</button>` : ''}`;
        
        card.onclick = (e) => {
          if (e.target.closest('button')) return;
          if (state.status === 'uploading') return showAlert('ë§ˆê° í›„ì— ì‘í’ˆì´ ê³µê°œë©ë‹ˆë‹¤.');
          if (state.status === 'upload_ended') { state.pending = () => openViewer(c); showPasswordModal("ê´€ë¦¬ì ì—´ëŒ"); return; }
          openViewer(c);
        };
        card.querySelector('.like-btn').onclick = (e) => { 
          e.stopPropagation(); 
          if (state.status === 'voting') toggleLike(c.id); 
          else showAlert(state.status === 'results' ? 'íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'íˆ¬í‘œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.'); 
        };
        if (isOwner && card.querySelector('.del-btn')) card.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); handleDelete(c.id); };
        grid.appendChild(card);
      });
    };

    const openViewer = (c) => {
      el('modalComicNickname').textContent = `${c.uploaderName} ì‘ê°€ë‹˜`;
      const con = el('modalImageContainer'); con.innerHTML = '';
      c.images.forEach(img => { const i = document.createElement('img'); i.src = img.imageUrl; i.className = "w-full rounded-2xl shadow-2xl border border-gray-800"; con.appendChild(i); });
      el('imageModal').style.display = 'flex';
    };

    const setupSync = () => {
      onSnapshot(doc(db, `artifacts/${APP_ID}/public/data/config/current`), (d) => {
        const data = d.data(); if (!data) return;
        state.status = data.status || ""; state.topic = data.topic || "";
        el('mainTitleDisplay').textContent = data.appTitle || "ë§Œíˆ¬";
        document.title = `${data.appTitle || "ë§Œíˆ¬"} - ë„¤ì»·ë§Œí™” íˆ¬í‘œ`;
        if (data.bannerUrl && state.status === "") { el('mainBanner').src = data.bannerUrl; el('mainBanner').classList.remove('hidden'); }
        else { el('mainBanner').classList.add('hidden'); }
        el('currentTopicText').textContent = state.topic;
        el('currentTopicDisplay').classList.toggle('hidden', !state.topic);
        refreshManagerButtons();
        renderComics();
      });
      onSnapshot(query(collection(db, `artifacts/${APP_ID}/public/data/comics`), orderBy("timestamp", "desc")), (s) => {
        state.comics = s.docs.map(d => ({ id: d.id, ...d.data() }));
        renderComics();
      });
    };

    const refreshManagerButtons = () => {
      const isMgr = auth.currentUser && !auth.currentUser.isAnonymous;
      el('startContestBtn').classList.toggle('hidden', !isMgr || state.status !== "");
      el('showUploadModalBtn').classList.toggle('hidden', !isMgr || state.status !== "uploading");
      el('endContestBtn').classList.toggle('hidden', !isMgr || state.status !== "uploading");
      el('startVotingBtn').classList.toggle('hidden', !isMgr || state.status !== "upload_ended");
      el('endVotingBtn').classList.toggle('hidden', !isMgr || state.status !== "voting");
      el('resetContestBtn').classList.toggle('hidden', !isMgr || state.status !== "results");
      el('openSettingsBtn').classList.toggle('hidden', !isMgr);
    };

    const toggleLike = async (id) => {
      if (!auth.currentUser) return showAlert("íˆ¬í‘œí•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const c = state.comics.find(x => x.id === id); const uid = auth.currentUser.uid;
      const userHasLikedAny = state.comics.some(x => x.id !== id && x.likes?.[uid]);
      if (!c.likes?.[uid] && userHasLikedAny) return showAlert("íˆ¬í‘œëŠ” í•œ ì‘í’ˆì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
      await updateDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, id), { [`likes.${uid}`]: c.likes?.[uid] ? deleteField() : true });
    };

    const handleDelete = async (id) => {
      if (confirm("ì •ë§ë¡œ ì´ ì‘í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        showLoading(true, "ì‘í’ˆ ì‚­ì œ ì¤‘...");
        const c = state.comics.find(x => x.id === id);
        for (const img of c.images) if (img.path) await deleteObject(storageRef(storage, img.path)).catch(() => {});
        await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, id));
        showLoading(false);
      }
    };

    const showPasswordModal = (title) => {
      el('passwordModalTitle').textContent = title; el('generalPasswordInput').value = ''; el('generalPasswordModal').style.display = 'flex'; el('generalPasswordInput').focus();
    };

    el('confirmPasswordBtn').onclick = () => {
      if (el('generalPasswordInput').value === ADMIN_PW) { el('generalPasswordModal').style.display = 'none'; if (state.pending) { state.pending(); state.pending = null; } }
      else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    };

    const resizeImg = (file, maxWidth = 1280, quality = 0.8) => {
      return new Promise((res, rej) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image(); img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = Math.round((height * maxWidth) / width); w = maxWidth; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
            canvas.toBlob((b) => res(b.size < file.size ? b : file), 'image/jpeg', quality);
          };
          img.onerror = rej;
        };
        reader.onerror = rej;
      });
    };

    el('comicFilesInput').onchange = (e) => { state.files = Array.from(e.target.files); renderPreviews(); };
    const renderPreviews = () => {
      const area = el('imagePreviewArea'); area.innerHTML = '';
      if (state.files.length === 0) return;
      state.files.forEach((f, i) => {
        const div = document.createElement('div'); div.className = 'preview-container';
        div.innerHTML = `<img src="${URL.createObjectURL(f)}" class="preview-image"><button class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-7 h-7 flex items-center justify-center font-bold shadow-lg">âœ•</button>`;
        div.querySelector('button').onclick = () => { state.files.splice(i, 1); renderPreviews(); };
        area.appendChild(div);
      });
    };

    el('submitComicBtn').onclick = async () => {
      const name = el('uploadNickname').value.trim(); if (!name || state.files.length === 0) return showAlert("ì´ë¦„ê³¼ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      showLoading(true, "ì´ë¯¸ì§€ ìµœì í™” ë° ì „ì†¡ ì¤‘...");
      try {
        const ref = doc(collection(db, `artifacts/${APP_ID}/public/data/comics`)); const imgs = [];
        for (let i = 0; i < state.files.length; i++) {
          const blob = await resizeImg(state.files[i]);
          const path = `mantu/${APP_ID}/${ref.id}/${i}_${Date.now()}.jpg`;
          const sRef = storageRef(storage, path); await uploadBytesResumable(sRef, blob);
          const url = await getDownloadURL(sRef); imgs.push({ imageUrl: url, path });
        }
        await setDoc(ref, { uploaderId: auth.currentUser.uid, uploaderName: name, images: imgs, likes: {}, timestamp: serverTimestamp(), topic: state.topic });
        el('uploadModal').style.display = 'none'; state.files = []; showAlert("ì‘í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } catch (e) { showAlert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); } showLoading(false);
    };

    el('openSettingsBtn').onclick = () => { state.pending = () => { el('newTitleInput').value = el('mainTitleDisplay').textContent; el('settingsModal').style.display = 'flex'; }; showPasswordModal("ê´€ë¦¬ì ì¸ì¦"); };
    el('closeSettingsModalBtn').onclick = () => el('settingsModal').style.display = 'none';
    el('saveTitleBtn').onclick = async () => {
      showLoading(true); await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { appTitle: el('newTitleInput').value }, { merge: true });
      showAlert("ì œëª©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); showLoading(false);
    };
    el('triggerBannerBtn').onclick = () => el('bannerFileInput').click();
    el('bannerFileInput').onchange = async (e) => {
      if (!e.target.files[0]) return; showLoading(true);
      try {
        const b = await resizeImg(e.target.files[0], 1920, 0.9);
        const sRef = storageRef(storage, `mantu/banners/${APP_ID}/main_${Date.now()}.jpg`);
        await uploadBytesResumable(sRef, b); const url = await getDownloadURL(sRef);
        await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { bannerUrl: url }, { merge: true }); showAlert("ë°°ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (e) { showAlert("ë°°ë„ˆ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); } showLoading(false);
    };

    el('downloadAllComicsBtn').onclick = async () => {
      if (state.comics.length === 0) return showAlert("ë‹¤ìš´ë¡œë“œí•  ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
      showLoading(true, "ì‘í’ˆ ìˆ˜ì§‘ ë° ì••ì¶• ì¤‘...");
      const zip = new JSZip();
      try {
        for (const c of state.comics) {
          const folder = zip.folder(c.uploaderName.replace(/[/\\?%*:|"<>]/g, '-'));
          for (let i = 0; i < c.images.length; i++) {
            const blob = await getBlob(storageRef(storage, c.images[i].path));
            folder.file(`${i + 1}.jpg`, blob);
          }
        }
        saveAs(await zip.generateAsync({ type: "blob" }), `ë§Œíˆ¬_ì „ì²´ì‘í’ˆ_${new Date().toLocaleDateString()}.zip`);
        showAlert("ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      } catch (e) { showAlert("CORS ì„¤ì • ë¯¸ë°˜ì˜ í˜¹ì€ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤."); } showLoading(false);
    };

    el('startContestBtn').onclick = () => { state.pending = () => el('topicModal').style.display = 'flex'; showPasswordModal("ëŒ€ì „ ì‹œì‘"); };
    el('submitTopicBtn').onclick = async () => {
      showLoading(true, "ëŒ€ì „ í™œì„±í™” ì¤‘...");
      await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'uploading', topic: el('topicInput').value, updatedAt: serverTimestamp() }, { merge: true });
      el('topicModal').style.display = 'none'; showLoading(false);
    };
    el('endContestBtn').onclick = () => { state.pending = () => setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'upload_ended' }, { merge: true }); showPasswordModal("ë§ˆê°"); };
    el('startVotingBtn').onclick = () => { state.pending = () => setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'voting' }, { merge: true }); showPasswordModal("íˆ¬í‘œ ì‹œì‘"); };
    el('endVotingBtn').onclick = () => { pendingAction = async () => await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'results' }, { merge: true }); showPasswordModal("ê²°ê³¼ ë°œí‘œ"); };
    el('resetContestBtn').onclick = () => {
      state.pending = async () => {
        if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          showLoading(true);
          for (const c of state.comics) { for (const img of c.images) await deleteObject(storageRef(storage, img.path)).catch(()=>{}); await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, c.id)); }
          await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: '', topic: '' }, { merge: true }); showLoading(false);
        }
      }; showPasswordModal("ì´ˆê¸°í™”");
    };

    // ğŸ’¡ ë°ì´í„° ë¡œë“œ ì¦‰ì‹œ ì‹œì‘ (ë¡œê·¸ì¸ ì—¬ë¶€ ë¬´ê´€)
    setupSync();
    onAuthStateChanged(auth, (user) => {
      el('userInfo').textContent = user ? (user.displayName || "ê´€ë¦¬ì") : "ë°©ë¬¸ì ëª¨ë“œ";
      el('signInBtn').classList.toggle('hidden', !!user);
      el('signOutBtn').classList.toggle('hidden', !user);
      refreshManagerButtons();
      renderComics();
    });

    el('signInBtn').onclick = () => signInWithPopup(auth, provider);
    el('signOutBtn').onclick = () => signOut(auth);
    el('showUploadModalBtn').onclick = () => { state.files = []; el('imagePreviewArea').innerHTML = ''; el('uploadModal').style.display = 'flex'; };
    el('cancelUploadBtn').onclick = () => el('uploadModal').style.display = 'none';
    el('closeImageModalBtn').onclick = () => el('imageModal').style.display = 'none';
    el('closePasswordModalBtn').onclick = () => el('generalPasswordModal').style.display = 'none';
    el('closeTopicModalBtn').onclick = () => el('topicModal').style.display = 'none';
    el('closeSettingsModalBtn').onclick = () => el('settingsModal').style.display = 'none';
  </script>
</body>
</html>
