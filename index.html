<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§Œíˆ¬ - ë„¤ì»·ë§Œí™” íˆ¬í‘œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      flex-direction: column;
      gap: 1rem;
    }
    .section-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
      text-align: center;
      width: 100%;
      max-width: 1200px;
    }
    #comic-grid { column-count: 2; column-gap: 1rem; margin-top: 1.5rem; display: block; }
    @media (min-width: 640px) { #comic-grid { column-count: 3; } }
    @media (min-width: 1024px) { #comic-grid { column-count: 4; } }
    @media (min-width: 1280px) { #comic-grid { column-count: 5; } }
    
    .comic-card { 
      position: relative; 
      transition: all .2s ease-in-out; 
      background: #333; 
      border-radius: 12px; 
      overflow: hidden; 
      margin-bottom: 1rem; 
      break-inside: avoid; 
      width: 100%; 
      display: block; 
      cursor: pointer; 
      border: 3px solid transparent; 
    }
    .comic-card.disabled { cursor: not-allowed; opacity: 0.7; }
    .comic-card.rank-1 { border-color: #FFD700; }
    .comic-card.rank-2 { border-color: #C0C0C0; }
    .comic-card.rank-3 { border-color: #CD7F32; }
    
    .rank-medal { 
      position: absolute; top: 8px; left: 8px; font-size: 1.8rem; line-height: 1; 
      text-shadow: 0 1px 3px rgba(0,0,0,0.5); z-index: 10; 
    }
    .comic-card:not(.disabled):hover { transform: translateY(-5px); background: #444; }
    
    .comic-card .content { 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      width: 100%; min-height: 120px; padding: 16px; text-align: center; background-color: #1a1a1a; position: relative; 
    }
    .comic-card .nickname-display { font-size: 1.25rem; font-weight: 700; color: #fff; word-break: break-all; }
    .comic-card .sub-text { font-size: 0.8rem; color: #aaa; margin-top: 4px; }
    .comic-card .info-footer { padding: 12px; background: #333; text-align: left; }
    
    .like-btn { 
      display: flex; align-items: center; gap: 6px; background: #555; color: white; 
      padding: 6px 10px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; 
      transition: all 0.2s ease; cursor: pointer; border: none; 
    }
    .like-btn.liked { background: #374151; color: white; }
    .like-btn:not(.disabled):hover:not(.liked) { background: #666; }
    .like-btn.disabled { background: #444; color: #777; cursor: not-allowed; }
    .like-count { font-size: 0.9rem; font-weight: 700; color: #ddd; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { 
      background-color: #1a1a1a; padding: 1.5rem; border-radius: 12px; 
      max-width: 90vw; max-height: 90vh; width: auto; display: flex; flex-direction: column; overflow-y: auto; 
    }
    
    /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ ì• ë‹ˆë©”ì´ì…˜ ê°•í™” */
    #imagePreviewArea { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; 
      margin-top: 1rem; padding: 12px; background: #1a1a1a; border-radius: 8px; min-height: 100px; 
    }
    .preview-container { 
      position: relative; width: 100%; aspect-ratio: 1 / 1; cursor: grab; 
      transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1), opacity 0.3s ease; 
      user-select: none;
    }
    .preview-container.dragging { 
      opacity: 0.4; 
      transform: scale(0.9); 
      z-index: 100;
    }
    .preview-container.drag-over {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }
    .preview-image { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #444; }
    .preview-number {
      position: absolute; top: 6px; left: 6px; background: rgba(0, 0, 0, 0.75);
      color: white; border-radius: 50%; width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .file-input-label { background: #444; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 700; display: block; }
    #comicFilesInput, #bannerFileInput { display: none; }
    
    .admin-button { background: #475569; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; }
    .admin-button:hover { background: #334155; }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; }
  </style>
</head>
<body class="text-white">

  <!-- ìƒë‹¨ ë°” -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2 mb-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-slate-600 hover:bg-slate-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë©”ì¸ íƒ€ì´í‹€ ì˜ì—­ -->
  <div class="w-full max-w-2xl flex items-center justify-center relative mb-6 px-12">
    <h1 id="mainTitleDisplay" class="text-4xl font-bold text-center text-white">ë§Œíˆ¬</h1>
    <button id="openSettingsBtn" class="absolute right-0 p-2 text-gray-500 hover:text-white transition-colors hidden" title="ê´€ë¦¬ì ì„¤ì •">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>
  </div>
  
  <!-- ë©”ì¸ ë°°ë„ˆ ì´ë¯¸ì§€ -->
  <div class="w-full max-w-2xl px-4">
    <img id="mainBanner" class="hidden w-full rounded-xl shadow-lg mb-6 object-cover border border-gray-800" alt="ë§Œíˆ¬ ë©”ì¸ ë°°ë„ˆ">
  </div>

  <h2 id="currentTopicDisplay" class="text-xl font-bold text-yellow-300 text-center mb-4 hidden">
    ì´ë²ˆ ì£¼ì œ: <span id="currentTopicText"></span>
  </h2>

  <!-- ë©”ì¸ ì½˜í…ì¸  ì„¹ì…˜ -->
  <div id="comics-section" class="section-card text-left">
    <section class="text-center mb-6 flex flex-wrap justify-center gap-4">
      <button id="startContestBtn" class="admin-button">ëŒ€ì „ ì‹œì‘</button>
      <button id="showUploadModalBtn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105 hidden">+ ì‘í’ˆ ì˜¬ë¦¬ê¸°</button>
      <button id="endContestBtn" class="admin-button hidden">ì—…ë¡œë“œ ë§ˆê°</button>
      <button id="startVotingBtn" class="admin-button hidden">íˆ¬í‘œ ì‹œì‘</button>
      <button id="endVotingBtn" class="admin-button hidden">íˆ¬í‘œ ì¢…ë£Œ ë° ê²°ê³¼ ë°œí‘œ</button>
      <button id="resetContestBtn" class="admin-button hidden">ì „ì²´ ì´ˆê¸°í™”</button>
    </section>
    
    <!-- ë§Œí™” ê·¸ë¦¬ë“œ -->
    <div id="comic-grid"></div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsModal" class="modal">
    <div class="modal-content w-full max-w-md">
      <h2 class="text-2xl font-bold mb-6 text-center">ê´€ë¦¬ì ì„¤ì •</h2>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-300 mb-1">ì•± íƒ€ì´í‹€ ë³€ê²½</label>
        <div class="flex gap-2">
          <input type="text" id="newTitleInput" class="flex-1 p-3 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="ì˜ˆ: ë§Œíˆ¬">
          <button id="saveTitleBtn" class="bg-slate-600 px-4 py-2 rounded-lg font-bold">ë³€ê²½</button>
        </div>
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-300 mb-1">ë°°ë„ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
        <button id="triggerBannerBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold border border-gray-600">íŒŒì¼ ì„ íƒ ë° ì—…ë¡œë“œ</button>
        <input type="file" id="bannerFileInput" accept="image/*">
      </div>
      <div class="flex justify-center mt-4">
        <button id="closeSettingsModalBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë§Œí™” ë³´ê¸° ëª¨ë‹¬ -->
  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <h3 id="modalComicNickname" class="text-2xl font-bold mb-4 text-white text-center"></h3>
      <div id="modalImageContainer" class="flex flex-col gap-4 max-w-md mx-auto"></div>
    </div>
  </div>

  <!-- ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="uploadModal" class="modal">
    <div class="modal-content w-full max-w-lg">
      <h2 class="text-2xl font-bold mb-6 text-center">ì‘í’ˆ ì˜¬ë¦¬ê¸°</h2>
      <div class="mb-4">
        <label for="uploadNickname" class="block text-sm font-medium text-gray-300 mb-1">ì‘ê°€ ë‹‰ë„¤ì„</label>
        <input type="text" id="uploadNickname" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-slate-500" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <div class="mb-4">
        <label for="comicFilesInput" class="file-input-label">ì´ë¯¸ì§€ ì„ íƒ</label>
        <input type="file" id="comicFilesInput" multiple accept="image/*">
        <p class="text-xs text-gray-500 mt-2 text-center">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•˜ì„¸ìš”.</p>
      </div>
      <div id="imagePreviewArea"></div>
      <div class="flex justify-end gap-3 mt-8">
        <button id="cancelUploadBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitComicBtn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg">ì œì¶œ</button>
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div id="generalPasswordModal" class="modal">
    <div class="modal-content w-full max-w-sm text-center">
      <h2 id="passwordModalTitle" class="text-xl font-bold mb-4">ê´€ë¦¬ì ì¸ì¦</h2>
      <input type="password" id="generalPasswordInput" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white text-center mb-2" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <p id="passwordErrorMessage" class="text-red-400 text-sm h-5 mb-4"></p>
      <div class="flex justify-center gap-2">
        <button id="closePasswordModalBtn" class="bg-gray-600 px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
        <button id="confirmPasswordBtn" class="bg-slate-700 px-4 py-2 rounded-lg">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì œì‹œì–´ ëª¨ë‹¬ -->
  <div id="topicModal" class="modal">
    <div class="modal-content w-full max-w-sm text-center">
      <h2 class="text-xl font-bold mb-4">ì œì‹œì–´ ì„¤ì •</h2>
      <input type="text" id="topicInput" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white text-center mb-4" placeholder="ëŒ€ì „ ì£¼ì œ ì…ë ¥">
      <div class="flex justify-center gap-2">
        <button id="closeTopicModalBtn" class="bg-gray-600 px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitTopicBtn" class="bg-slate-700 px-4 py-2 rounded-lg">ì‹œì‘</button>
      </div>
    </div>
  </div>

  <div id="alert-modal" class="modal"><div class="modal-content max-w-xs text-center"><p id="modal-message" class="text-white text-lg mb-6"></p><div class="flex justify-center gap-3"><button id="modal-cancel-btn" class="px-5 py-2 bg-gray-600 rounded-md hidden">ì·¨ì†Œ</button><button id="modal-confirm-btn" class="px-5 py-2 bg-slate-700 rounded-md">í™•ì¸</button></div></div></div>
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 z-[2000] flex items-center justify-center hidden"><div class="flex flex-col items-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div><p class="text-white text-lg">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, deleteDoc, collection, onSnapshot, addDoc, updateDoc, serverTimestamp, query, orderBy, limit, deleteField, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBqtqjmEIPydo7ibbGePf_oEb0GXVcZI6E",
      authDomain: "ne-cut-battle.firebaseapp.com",
      projectId: "ne-cut-battle",
      storageBucket: "ne-cut-battle.firebasestorage.app",
      messagingSenderId: "565872837701",
      appId: "1:565872837701:web:3c57c4bab8d37644018f2c"
    };

    const APP_ID = "necut_battle_2025";
    const ADMIN_PW = "0614";

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    let currentStatus = "", currentTopic = "", comics = [], uploadedFiles = [], dragStartIndex = null, pendingAction = null;

    const el = (id) => document.getElementById(id);
    const showLoading = (show) => el('loading-overlay').classList.toggle('hidden', !show);

    const showAlert = (msg, isConfirm = false) => {
      el('modal-message').textContent = msg;
      el('modal-cancel-btn').classList.toggle('hidden', !isConfirm);
      el('alert-modal').style.display = 'flex';
      return new Promise(res => {
        el('modal-confirm-btn').onclick = () => { el('alert-modal').style.display = 'none'; res(true); };
        el('modal-cancel-btn').onclick = () => { el('alert-modal').style.display = 'none'; res(false); };
      });
    };

    const updateAuthUI = (user) => {
      const isMgr = user && !user.isAnonymous;
      el('userInfo').textContent = user ? user.displayName : "ë¡œê·¸ì¸ í•„ìš”";
      el('signInBtn').classList.toggle('hidden', !!user);
      el('signOutBtn').classList.toggle('hidden', !user);
      el('openSettingsBtn').classList.toggle('hidden', !isMgr);
    };

    const renderComics = () => {
      const grid = el('comic-grid'); grid.innerHTML = '';
      const displayData = [...comics];
      if (currentStatus === 'results') displayData.sort((a, b) => Object.keys(b.likes || {}).length - Object.keys(a.likes || {}).length);
      
      displayData.forEach((comic, idx) => {
        const likes = Object.keys(comic.likes || {}).length;
        const hasLiked = auth.currentUser && comic.likes?.[auth.currentUser.uid];
        const isOwner = auth.currentUser && comic.uploaderId === auth.currentUser.uid;
        let rankClass = "", medal = "";
        if (currentStatus === 'results' && idx < 3 && likes > 0) {
          rankClass = `rank-${idx + 1}`; medal = `<div class="rank-medal">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][idx]}</div>`;
        }
        const card = document.createElement('div');
        card.className = `comic-card ${rankClass} ${currentStatus === 'uploading' ? 'disabled' : ''}`;
        card.innerHTML = `${medal}<div class="content"><span class="nickname-display">${comic.uploaderName}</span><span class="sub-text">${comic.images?.length || 0}ì»·</span></div><div class="info-footer"><div class="like-section"><button class="like-btn ${hasLiked ? 'liked' : ''} ${currentStatus !== 'voting' ? 'disabled' : ''}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 11-3 0v-6zM6 10.333v5.167c0 .83.682 1.5 1.502 1.5h6.666A1.5 1.5 0 0015.5 15.5V8.167A1.5 1.5 0 0014 6.667h-2.167A2.5 2.5 0 009.5 4.5V3.083A1.5 1.5 0 008 1.583 1.5 1.5 0 006.5 3v7.333z"/></svg><span>ì¢‹ì•„ìš”</span></button><span class="like-count">${likes}</span></div></div>${isOwner && currentStatus !== 'results' ? `<button class="absolute top-2 right-2 text-red-400 p-1 bg-black bg-opacity-30 rounded-full delete-btn">âœ•</button>` : ''}`;
        
        card.onclick = (e) => {
          if (e.target.closest('button')) return;
          if (currentStatus === 'uploading') return showAlert('ì—…ë¡œë“œ ê¸°ê°„ì—ëŠ” ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          if (currentStatus === 'upload_ended') { pendingAction = () => openViewer(comic); showPasswordModal("ë¯¸ë¦¬ë³´ê¸°"); return; }
          openViewer(comic);
        };
        card.querySelector('.like-btn').onclick = (e) => { e.stopPropagation(); if (currentStatus === 'voting') toggleLike(comic.id); else showAlert('íˆ¬í‘œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.'); };
        if (isOwner) card.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); handleDelete(comic.id); };
        grid.appendChild(card);
      });
    };

    const openViewer = (comic) => {
      el('modalComicNickname').textContent = `${comic.uploaderName} ì‘ê°€ì˜ ì‘í’ˆ`;
      const container = el('modalImageContainer'); container.innerHTML = '';
      comic.images.forEach(img => { const i = document.createElement('img'); i.src = img.imageUrl; i.className = "w-full rounded-lg shadow-md"; container.appendChild(i); });
      el('imageModal').style.display = 'flex';
    };

    const setupSync = () => {
      onSnapshot(doc(db, `artifacts/${APP_ID}/public/data/config/current`), (d) => {
        const data = d.data(); if (!data) return;
        currentStatus = data.status || ""; currentTopic = data.topic || "";
        el('mainTitleDisplay').textContent = data.appTitle || "ë§Œíˆ¬";
        document.title = `${data.appTitle || "ë§Œíˆ¬"} - ë„¤ì»·ë§Œí™” íˆ¬í‘œ`;
        
        if (data.bannerUrl && currentStatus === "") { 
          el('mainBanner').src = data.bannerUrl; 
          el('mainBanner').classList.remove('hidden'); 
        } else { 
          el('mainBanner').classList.add('hidden'); 
        }

        el('currentTopicText').textContent = currentTopic;
        el('currentTopicDisplay').classList.toggle('hidden', !currentTopic);
        
        const isMgr = auth.currentUser && !auth.currentUser.isAnonymous;
        el('startContestBtn').classList.toggle('hidden', !isMgr || currentStatus !== "");
        el('showUploadModalBtn').classList.toggle('hidden', !isMgr || currentStatus !== "uploading");
        el('endContestBtn').classList.toggle('hidden', !isMgr || currentStatus !== "uploading");
        el('startVotingBtn').classList.toggle('hidden', !isMgr || currentStatus !== "upload_ended");
        el('endVotingBtn').classList.toggle('hidden', !isMgr || currentStatus !== "voting");
        el('resetContestBtn').classList.toggle('hidden', !isMgr || currentStatus !== "results");
        renderComics();
      });
      const q = query(collection(db, `artifacts/${APP_ID}/public/data/comics`), orderBy("timestamp", "desc"));
      onSnapshot(q, (snap) => { comics = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderComics(); });
    };

    const toggleLike = async (id) => {
      const comic = comics.find(c => c.id === id); const uid = auth.currentUser.uid;
      const userHasLikedAny = comics.some(c => c.id !== id && c.likes?.[uid]);
      if (!comic.likes?.[uid] && userHasLikedAny) return showAlert("íˆ¬í‘œëŠ” í•˜ë‚˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
      await updateDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, id), { [`likes.${uid}`]: comic.likes?.[uid] ? deleteField() : true });
    };

    const handleDelete = async (id) => {
      if (await showAlert("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", true)) {
        showLoading(true);
        try {
          const comic = comics.find(c => c.id === id);
          for (const img of comic.images) { if (img.path) await deleteObject(storageRef(storage, img.path)).catch(() => {}); }
          await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, id));
        } catch (e) { showAlert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
        showLoading(false);
      }
    };

    const showPasswordModal = (title) => {
      el('passwordModalTitle').textContent = title; el('generalPasswordInput').value = ''; el('passwordErrorMessage').textContent = '';
      el('generalPasswordModal').style.display = 'flex';
    };

    el('confirmPasswordBtn').onclick = () => {
      if (el('generalPasswordInput').value === ADMIN_PW) { 
        el('generalPasswordModal').style.display = 'none'; 
        if (pendingAction) { pendingAction(); pendingAction = null; } 
      } else el('passwordErrorMessage').textContent = "í‹€ë ¸ìŠµë‹ˆë‹¤.";
    };

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ (4ì¥ ì œí•œ ì‚­ì œ ë° ì• ë‹ˆë©”ì´ì…˜ ê°•í™”)
    el('comicFilesInput').onchange = (e) => { 
      uploadedFiles = Array.from(e.target.files); 
      renderPreviews(); 
    };

    const renderPreviews = () => {
      const area = el('imagePreviewArea'); area.innerHTML = '';
      if (uploadedFiles.length === 0) {
        area.innerHTML = '<p class="text-gray-500 text-sm col-span-full py-4">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
        return;
      }

      uploadedFiles.forEach((file, i) => {
        const div = document.createElement('div'); 
        div.className = 'preview-container'; 
        div.draggable = true;
        div.dataset.index = i;
        
        div.innerHTML = `
          <span class="preview-number">${i+1}</span>
          <img src="${URL.createObjectURL(file)}" class="preview-image">
          <button class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-lg delete-preview-btn">Ã—</button>
        `;

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸
        div.ondragstart = (ev) => { 
          dragStartIndex = i; 
          div.classList.add('dragging');
          ev.dataTransfer.effectAllowed = 'move';
        };
        
        div.ondragenter = () => div.classList.add('drag-over');
        div.ondragleave = () => div.classList.remove('drag-over');
        
        div.ondragover = (ev) => ev.preventDefault();
        
        div.ondrop = () => {
          div.classList.remove('drag-over');
          const item = uploadedFiles.splice(dragStartIndex, 1)[0];
          uploadedFiles.splice(i, 0, item);
          renderPreviews();
        };
        
        div.ondragend = () => div.classList.remove('dragging');

        // ì´ë¯¸ì§€ ì‚­ì œ ë²„íŠ¼
        div.querySelector('.delete-preview-btn').onclick = (e) => {
          e.stopPropagation();
          uploadedFiles.splice(i, 1);
          renderPreviews();
        };

        area.appendChild(div);
      });
    };

    el('submitComicBtn').onclick = async () => {
      const name = el('uploadNickname').value.trim(); 
      if (!name || uploadedFiles.length === 0) return showAlert("ì´ë¦„ê³¼ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      showLoading(true);
      try {
        const comicRef = doc(collection(db, `artifacts/${APP_ID}/public/data/comics`)); const imgs = [];
        for (let i = 0; i < uploadedFiles.length; i++) {
          const path = `mantu/${APP_ID}/${comicRef.id}/${i}_${Date.now()}`;
          const sRef = storageRef(storage, path);
          await uploadBytesResumable(sRef, uploadedFiles[i]);
          const url = await getDownloadURL(sRef); imgs.push({ imageUrl: url, path });
        }
        await setDoc(comicRef, { uploaderId: auth.currentUser.uid, uploaderName: name, images: imgs, likes: {}, timestamp: serverTimestamp(), topic: currentTopic });
        el('uploadModal').style.display = 'none'; 
        uploadedFiles = [];
        showAlert("ì‘í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } catch (e) { showAlert("ì‹¤íŒ¨: " + e.message); }
      showLoading(false);
    };

    el('openSettingsBtn').onclick = () => { pendingAction = () => { el('newTitleInput').value = el('mainTitleDisplay').textContent; el('settingsModal').style.display = 'flex'; }; showPasswordModal("ê´€ë¦¬ì ì„¤ì •"); };
    el('closeSettingsModalBtn').onclick = () => el('settingsModal').style.display = 'none';

    el('saveTitleBtn').onclick = async () => {
      const title = el('newTitleInput').value.trim(); if (!title) return;
      showLoading(true);
      try {
        await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { appTitle: title }, { merge: true });
        showAlert("ë³€ê²½ ì™„ë£Œ");
      } catch (e) { showAlert("ì‹¤íŒ¨: " + e.message); }
      showLoading(false);
    };

    el('triggerBannerBtn').onclick = () => el('bannerFileInput').click();
    el('bannerFileInput').onchange = async (e) => {
      const file = e.target.files[0]; if (!file) return;
      showLoading(true);
      try {
        const path = `mantu/banners/${APP_ID}/banner_${Date.now()}`;
        const sRef = storageRef(storage, path);
        await uploadBytesResumable(sRef, file);
        const url = await getDownloadURL(sRef);
        await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { bannerUrl: url }, { merge: true });
        showAlert("ë°°ë„ˆ ë³€ê²½ ì™„ë£Œ");
      } catch (e) { showAlert("ì‹¤íŒ¨: " + e.message); }
      showLoading(false);
    };

    el('startContestBtn').onclick = () => { pendingAction = () => el('topicModal').style.display = 'flex'; showPasswordModal("ì‹œì‘"); };
    el('submitTopicBtn').onclick = async () => {
      const topic = el('topicInput').value.trim(); if (!topic) return;
      showLoading(true);
      await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'uploading', topic, updatedAt: serverTimestamp() }, { merge: true });
      el('topicModal').style.display = 'none';
      showLoading(false);
    };

    el('endContestBtn').onclick = () => { pendingAction = async () => await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'upload_ended' }, { merge: true }); showPasswordModal("ë§ˆê°"); };
    el('startVotingBtn').onclick = () => { pendingAction = async () => await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'voting' }, { merge: true }); showPasswordModal("íˆ¬í‘œ ì‹œì‘"); };
    el('endVotingBtn').onclick = () => { pendingAction = async () => await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: 'results' }, { merge: true }); showPasswordModal("ê²°ê³¼ ë°œí‘œ"); };
    el('resetContestBtn').onclick = () => {
      pendingAction = async () => {
        if (await showAlert("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", true)) {
          showLoading(true);
          for (const c of comics) { for (const img of c.images) await deleteObject(storageRef(storage, img.path)).catch(()=>{}); await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/comics`, c.id)); }
          await setDoc(doc(db, `artifacts/${APP_ID}/public/data/config/current`), { status: '', topic: '' }, { merge: true });
          showLoading(false);
        }
      }; showPasswordModal("ì´ˆê¸°í™”");
    };

    onAuthStateChanged(auth, (user) => { updateAuthUI(user); if (user) setupSync(); });
    el('signInBtn').onclick = () => signInWithPopup(auth, provider);
    el('signOutBtn').onclick = () => signOut(auth);
    el('showUploadModalBtn').onclick = () => {
      uploadedFiles = [];
      el('imagePreviewArea').innerHTML = '';
      el('uploadModal').style.display = 'flex';
    };
    el('cancelUploadBtn').onclick = () => el('uploadModal').style.display = 'none';
    el('closeImageModalBtn').onclick = () => el('imageModal').style.display = 'none';
    el('closePasswordModalBtn').onclick = () => el('generalPasswordModal').style.display = 'none';
    el('closeTopicModalBtn').onclick = () => el('topicModal').style.display = 'none';
  </script>
</body>
</html>
